<!DOCTYPE html>
<style>
  body { min-height: 100vh; margin: 0; background: #111; display: flex; }
  body { align-items: center; justify-content: center; flex-direction: column; }
  video { width: 512px; outline: none; }
</style>
<script type='module'>
var n,o,e,t;const i=Object.assign,a=n=>(...o)=>i(document.createElement(n),...o),c=a("canvas"),s=(n,o,e)=>(...t)=>(e(o),t.forEach((e=>e(n,o))),e(null),o),r=(n,o=34962)=>{const e=n.createBuffer();return s(n,e,(e=>n.bindBuffer(o,e)))},v=(n,o=3553)=>{const e=n.createTexture();return s(n,e,(e=>n.bindTexture(o,e)))},l=()=>{},p=(n,...o)=>n>4?l:(...n)=>console.log(...o,...n),u=p(4,"%c debug ","background:#007fff;color:#ffffff"),f=p(5,"%c trace ","background:#7f7f7f;color:#ffffff"),_=(n,o)=>`\n#ifndef LIB_${n}\n#define LIB_${n}\n${o}\n#endif\n`,m=(n,o,e)=>{const t="#version 300 es\n"+e,i=n.createShader(o);if(n.shaderSource(i,t),n.compileShader(i),!n.getShaderParameter(i,35713)){const o=n.getShaderInfoLog(i);throw Error(`Shader error:\n${o}\n${((n,o=1)=>n.replace(/^/gm,(()=>(o+++": ").padStart(5,"0"))))(t)}\n`)}return i},x=(n,o,e)=>{const t=n.createProgram();if(n.attachShader(t,m(n,35633,o)),n.attachShader(t,m(n,35632,e)),n.linkProgram(t),!n.getProgramParameter(t,35714)){const o=n.getProgramInfoLog(t);throw Error("Program error: "+o)}n.useProgram(t);for(let o,e=0;o=n.getUniformLocation(t,"uSampler"+e);)n.uniform1i(o,e++);return n.useProgram(null),t},h=(n,o)=>{const e={};for(let t=n.getProgramParameter(o,35718),i=0;t>i;i++){const{name:t}=n.getActiveUniform(o,i),a=n.getUniformLocation(o,t);e[t.replace(/\[0\]$/,"")]=a}return e},y=(...n)=>(o,e)=>{n.reduce(((n,e)=>()=>e(o,n)),e)()},S=n=>(o,e)=>{const t=o.getParameter(35725);o.useProgram(n),e(),o.useProgram(t)},d=n=>(o,e)=>{const t=o.getParameter(36006);o.bindFramebuffer(36160,n),e(),o.bindFramebuffer(36160,t)},P=(n,o,e,t)=>(i,a)=>{const[c,s,r,v]=i.getParameter(2978);i.viewport(n,o,e,t),a(),i.viewport(c,s,r,v)},C=(...n)=>(o,e)=>{for(const[e,t]of n.entries())o.activeTexture(33984+e),o.bindTexture(3553,t);e();for(const e of n.keys())o.activeTexture(33984+e),o.bindTexture(3553,null)},g=(n=>{try{return n()}catch(n){throw alert(n),n}})((()=>((n,o)=>{const e=c().getContext("webgl2",n);if(!e)throw Error("WebGL2 is unavailable");const t=e.getExtension("WEBGL_debug_renderer_info");t&&(u(e.getParameter(t.UNMASKED_VENDOR_WEBGL)),u(e.getParameter(t.UNMASKED_RENDERER_WEBGL))),u(e.getParameter(7936)),u(e.getParameter(7937)),u(e.getParameter(7938)),u(e.getParameter(35724)),u(e.getSupportedExtensions()?.join(", "));for(const n of o)if(!e.getExtension(n))throw Error(`"${n}" extension is unavailable`);return e})({},["EXT_color_buffer_float","EXT_float_blend","OES_texture_float_linear"])));g.getExtension("OES_texture_float_linear"),(n=>{n.video=a("video")({src:location.search.slice(1)||"videos/MAGIC_FLUIDS.webm",crossOrigin:"anonymous",controls:!0,autoplay:!0,loop:!0}),window.addEventListener("dragover",(n=>{n.preventDefault()})),window.addEventListener("drop",(o=>{o.preventDefault();const[e]=o.dataTransfer.files;if(e){const o=URL.createObjectURL(e);n.video.src=o}})),document.body.append(n.video,g.canvas)})(n||(n={})),(n=>{n.linAlg=_("LINALG","\n    #define rot(a) mat2(cos(a), sin(a), -sin(a), cos(a))\n    #define rotx(a) mat4(1.0, 0.0, 0.0, 0.0, 0.0, cos(a), sin(a), 0.0, 0.0, -sin(a), cos(a), 0.0, 0.0, 0.0, 0.0, 1.0)\n    #define roty(a) mat4(cos(a), 0.0, -sin(a), 0.0, 0.0, 1.0, 0.0, 0.0, sin(a), 0.0, cos(a), 0.0, 0.0, 0.0, 0.0, 1.0)\n    #define rotz(a) mat4(cos(a), sin(a), 0.0, 0.0, -sin(a), cos(a), 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0)\n    #define rot3(x, y, z) rotz(x)*roty(y)*rotx(z)\n    #define scale(x, y, z) mat4(x, 0.0, 0.0, 0.0, 0.0, y, 0.0, 0.0, 0.0, 0.0, z, 0.0, 0.0, 0.0, 0.0, 1.0)\n    #define translate(x, y, z) mat4(1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, x, y, z, 1.0)\n    #define transform(m4, v3) (m4*vec4(v3, 1.0)).xyz\n    #define perspective(fov, r, n, f) mat4(      1.0/r/tan(0.5*fov), 0.0, 0.0, 0.0,      0.0, 1.0/tan(0.5*fov), 0.0, 0.0,      0.0, 0.0, -(f + n)/(f - n), -1.0,      0.0, 0.0, -(2.0*f*n)/(f - n), 0.0    )\n  "),n.sRGB=_("SRGB","\n    #define diag3(v) mat3((v).x, 0.0, 0.0, 0.0, (v).y, 0.0, 0.0, 0.0, (v).z)\n    #define xyY_to_XYZ(x, y, Y) vec3(Y/y*x, Y, Y/y*(1.0 - x - y))\n    #define xy_to_XYZ(x, y) vec3(x/y, 1.0, (1.0 - x - y)/y)\n    #define xy_to_xyz(x, y) vec3(x, y, 1.0 - x - y)\n\n    const mat3 BFD = mat3(0.8951, -0.7502, 0.0389, 0.2664, 1.7135, -0.0685, -0.1614, 0.0367, 1.0296);\n\n    const vec3 D50 = xy_to_XYZ(0.34567, 0.35850);\n    const vec3 D65 = xy_to_XYZ(0.31271, 0.32902);\n    const mat3 D65_TO_D50 = inverse(BFD)*diag3((BFD*D50)/(BFD*D65))*BFD;\n\n    const mat3 sRGB = mat3(xy_to_XYZ(0.64, 0.33), xy_to_XYZ(0.30, 0.60), xy_to_XYZ(0.15, 0.06));\n    const mat3 sRGB_TO_XYZ_D65 = sRGB*diag3(inverse(sRGB)*D65);\n    const mat3 sRGB_TO_XYZ_D50 = D65_TO_D50*sRGB_TO_XYZ_D65;\n    const mat3 XYZ_D65_TO_sRGB = inverse(sRGB_TO_XYZ_D65);\n    const mat3 XYZ_D50_TO_sRGB = inverse(sRGB_TO_XYZ_D50);\n\n    vec3 sRGB_OETF(vec3 c) {\n      vec3 a = 12.92*c;\n      vec3 b = 1.055*pow(c, vec3(1.0/2.4)) - 0.055;\n      return mix(a, b, greaterThan(c, vec3(0.00313066844250063)));\n    }\n\n    vec3 sRGB_EOTF(vec3 c) {\n      vec3 a = c/12.92;\n      vec3 b = pow((c + 0.055)/1.055, vec3(2.4));\n      return mix(a, b, greaterThan(c, vec3(0.0404482362771082)));\n    }\n  "),n.CAM16=_("CAM16",`\n    ${n.sRGB}\n\n    #define adapt_aux(x) pow(F_L*abs(x), vec3(0.42))\n    #define adapt(x) 400.0*sign(x)*adapt_aux(x)/(27.13 + adapt_aux(x))\n    #define unadapt(x) sign(x)/F_L*pow(27.13*abs(x)/(400.0 - abs(x)), vec3(1.0/0.42))\n\n    const mat3 M16 = mat3(\n      +0.401288, -0.250268, -0.002079,\n      +0.650173, +1.204414, +0.048952,\n      -0.051461, +0.045854, +0.953127\n    );\n\n    // sRGB conditions, average surround\n    const vec3 XYZ_w = D65;\n    const float Y_w = XYZ_w.y;\n    const float Y_b = 0.2;\n    const float L_w = 64.0/radians(180.0);\n    const float L_A = L_w*Y_b/Y_w;\n    const float F = 1.0;\n    const float c = 0.69;\n    const float N_c = F;\n\n    // step 0*\n    const vec3 RGB_w = M16*XYZ_w;\n    const float D = 1.0; // clamp(F*(1.0 - 1.0/3.6*exp((-L_A - 42.0)/92.0)), 0.0, 1.0);\n    const vec3 D_RGB = D*(Y_w/RGB_w) + 1.0 - D;\n    const float k4 = pow(1.0/(5.0*L_A + 1.0), 4.0);\n    const float F_L = k4*L_A + 0.1*pow(1.0 - k4, 2.0)*pow(5.0*L_A, 1.0/3.0);\n    const float n = Y_b/Y_w;\n    const float z = 1.48 + sqrt(n);\n    const float N_bb = 0.725/pow(n, 0.2);\n    const float N_cb = N_bb;\n    const vec3 RGB_cw = D_RGB*RGB_w;\n    const vec3 RGB_aw = adapt(RGB_cw);\n    const float A_w = dot(vec3(2.0, 1.0, 0.05), RGB_aw)*N_bb;\n\n    vec3 XYZ_D65_to_CAM16(vec3 XYZ) {\n      // step 1\n      vec3 RGB = M16*XYZ;\n      // step 2\n      vec3 RGB_c = D_RGB*RGB;\n      // step 3*\n      vec3 RGB_a = adapt(RGB_c);\n      // step 4*\n      const mat3x4 m = 1.0/1980.0*mat3x4(\n        3960.0, 1980.0, 220.0, 1980.0,\n        1980.0, -2160.0, 220.0, 1980.0,\n        99.0, 180.0, -440.0, 2079.0\n      );\n      vec4 aux = m*RGB_a; // p_2, a, b, u\n      float h = atan(aux.z, aux.y);\n      // step 5\n      float e_t = 0.25*(cos(h + 2.0) + 3.8);\n      // step 6*\n      float A = aux.x*N_bb;\n      // step 7\n      float J = pow(A/A_w, c*z);\n      // step 8\n      // step 9*\n      float t = 5e4/13.0*N_c*N_cb*e_t*length(aux.yz)/(aux.w + 0.305);\n      float alpha = pow(t, 0.9)*pow(1.64 - pow(0.29, n), 0.73);\n      float C = 0.01*alpha*sqrt(J);\n      float M = C*pow(F_L, 0.25);\n      return vec3(J, M, h);\n    }\n\n    vec3 CAM16_to_XYZ_D65(vec3 JMh) {\n      // step 1\n      // step 1-1\n      // step 1-2*\n      float C = JMh.y/pow(F_L, 0.25);\n      float alpha = JMh.x == 0.0 ? 0.0 : 100.0*C/sqrt(JMh.x);\n      float t = pow(alpha/pow(1.64 - pow(0.29, n), 0.73), 1.0/0.9);\n      // step 1-3\n      // step 2*\n      float e_t = 0.25*(cos(JMh.z + 2.0) + 3.8);\n      float A = A_w*pow(JMh.x, 1.0/(c*z));\n      float p_1 = 5e4/13.0*N_c*N_cb*e_t;\n      float p_2 = A/N_bb;\n      // step 3*\n      vec2 cs = vec2(cos(JMh.z), sin(JMh.z));\n      float r = 23.0*(p_2 + 0.305)*t/(23.0*p_1 + t*dot(vec2(11.0, 108.0), cs));\n      vec2 ab = r*cs;\n      // step 4\n      const mat3 m = 1.0/1403.0*mat3(\n        460.0, 460.0, 460.0,\n        451.0, -891.0, -220.0,\n        288.0, -261.0, -6300.0\n      );\n      vec3 RGB_a = m*vec3(p_2, ab);\n      // step 5*\n      vec3 RGB_c = unadapt(RGB_a);\n      // step 6\n      vec3 RGB = RGB_c/D_RGB;\n      // step 7\n      return inverse(M16)*RGB;\n    }\n\n    vec3 XYZ_D65_to_CAM16_UCS(vec3 XYZ) {\n      vec3 JMh = XYZ_D65_to_CAM16(XYZ);\n      float J = (1.0 + 0.7)*JMh.x/(1.0 + 0.7*JMh.x);\n      float M = 1.0/2.28*log(1.0 + 2.28*JMh.y);\n      return vec3(J, M, JMh.z);\n    }\n\n    vec3 CAM16_UCS_to_XYZ_D65(vec3 JMh) {\n      float J = JMh.x/(1.0 - (JMh.x - 1.0)*0.7);\n      float M = (exp(JMh.y*2.28) - 1.0)/2.28;\n      return CAM16_to_XYZ_D65(vec3(J, M, JMh.z));\n    }\n  `),n.UCS=_("UCS",`\n    ${n.CAM16}\n\n    // ScalingMatrix[{1, 1, 1}/Sqrt[3]] .\n    // RotationMatrix[5/6 Pi, {1, 0, 0}] .\n    // RotationMatrix[ArcTan[1/Sqrt[2]], {0, 1, 0}] .\n    // RotationMatrix[-1/4 Pi, {0, 0, 1}]\n    const mat3 rgb_to_jab = mat3(\n      1.0/3.0, sqrt(2.0)/3.0, 0.0,\n      1.0/3.0, -1.0/(3.0*sqrt(2.0)), 1.0/sqrt(6.0),\n      1.0/3.0, -1.0/(3.0*sqrt(2.0)), -1.0/sqrt(6.0)\n    );\n\n    vec3 sRGB_to_UCS(vec3 sRGB) {\n      // vec3 JMh = XYZ_D65_to_CAM16_UCS(sRGB_TO_XYZ_D65*sRGB);\n      // return vec3(JMh.x, JMh.y*vec2(cos(JMh.z), sin(JMh.z)));\n      return rgb_to_jab*sRGB;\n    }\n\n    vec3 UCS_to_sRGB(vec3 UCS) {\n      // vec3 JMh = vec3(UCS.x, length(UCS.yz), atan(UCS.z, UCS.y));\n      // return XYZ_D65_TO_sRGB*CAM16_UCS_to_XYZ_D65(JMh);\n      return inverse(rgb_to_jab)*UCS;\n    }\n  `),n.ACES=_("ACES","\n    vec3 ACES(vec3 color) {\n      const mat3 x = mat3(+0.59719, +0.07600, +0.02840, +0.35458, +0.90834, +0.13383, +0.04823, +0.01566, +0.83777);\n      const mat3 y = mat3(+1.60475, -0.10208, -0.00327, -0.53108, +1.10813, -0.07276, -0.07367, -0.00605, +1.07602);\n      vec3 v = x*color;\n      vec3 a = v*(v + 0.0245786) - 0.000090537;\n      vec3 b = v*(0.983729*v + 0.4329510) + 0.238081;\n      return clamp(y*(a/b), 0.0, 1.0);\n    }\n  "),n.kMeans=_("KMEANS","\n    #define K 25\n\n    uniform vec3 uMeans[K];\n\n    int closest(vec3 point) {\n      struct Pair { int i; float d; };\n      Pair min = Pair(0, 1e10);\n      for (int i = 0; i < K; i++) {\n        vec3 v = uMeans[i] - point;\n        float d = dot(v, v);\n        if (d < min.d) min = Pair(i, d);\n      }\n      return min.i;\n    }\n  ")})(o||(o={})),(n=>{f("preparing programs"),n.lanczos=x(g,"\n    layout(location=0) in vec2 aPosition;\n    out vec2 vPosition;\n\n    void main() {\n      vPosition = 0.5 + 0.5*aPosition;\n      gl_Position = vec4(aPosition, 0.0, 1.0);\n    }\n  ","\n    precision highp float;\n    uniform sampler2D uSampler0;\n    uniform vec2 uDirection;\n    in vec2 vPosition;\n    out vec4 fColor;\n\n    float lanczos(float a, float x) {\n      const float pi = radians(180.0);\n      return x == 0.0 ? 1.0 : a*sin(pi*x)*sin(pi*x/a)/(pi*pi*x*x);\n    }\n\n    void main() {\n      vec2 px = uDirection/vec2(textureSize(uSampler0, 0));\n      vec3 acc = vec3(0.0);\n      for (float x = -3.0; x <= 3.0; x += 1.0) {\n        vec4 t = texture(uSampler0, vPosition + px*x);\n        acc += lanczos(3.0, x)*t.rgb;\n      }\n      fColor = vec4(acc, 1.0);\n    }\n  "),n.test=x(g,"\n    layout(location=0) in vec2 aPosition;\n    out vec2 vPosition;\n\n    void main() {\n      vPosition = aPosition;\n      gl_Position = vec4(aPosition, 0.0, 1.0);\n    }\n  ",`\n    precision highp float;\n    uniform sampler2D uSampler0;\n    uniform float uTime;\n    in vec2 vPosition;\n    out vec4 fColor;\n\n    ${o.CAM16}\n    ${o.ACES}\n\n    void main() {\n      vec3 c = smoothstep(0.02, 0.01, vec3(\n        length(vec2(-0.25, 0.0) - vPosition),\n        length(vec2( 0.00, 0.0) - vPosition),\n        length(vec2(+0.25, 0.0) - vPosition)\n      ));\n      c *= pow(10.0, 15.0*smoothstep(1.0, 10.0, uTime)) - 1.0;\n      fColor = vec4(sRGB_OETF(c), 1.0);\n    }\n  `),n.convert=x(g,"\n    layout(location=0) in vec2 aPosition;\n    out vec2 vPosition;\n\n    void main() {\n      vPosition = 0.5 + 0.5*aPosition;\n      gl_Position = vec4(aPosition, 0.0, 1.0);\n    }\n  ",`\n    precision highp float;\n    uniform sampler2D uSampler0;\n    in vec2 vPosition;\n    out vec4 fColor;\n\n    ${o.UCS}\n\n    void main() {\n      vec3 sRGB = sRGB_EOTF(texture(uSampler0, vPosition).rgb);\n      fColor = vec4(sRGB_to_UCS(sRGB), 1.0);\n    }\n  `),n.update=x(g,`\n    uniform sampler2D uSampler0;\n    layout(location=1) in int aPosition;\n    out vec3 vColor;\n\n    ${o.kMeans}\n\n    void main() {\n      ivec2 ts = textureSize(uSampler0, 0);\n      ivec2 xy = ivec2(aPosition%ts.x, aPosition/ts.x);\n      vec2 uv = (0.5 + vec2(xy))/vec2(ts);\n      vec3 Jab = texture(uSampler0, uv).xyz;\n      float x = (0.5 + float(closest(Jab)))/float(K);\n      gl_Position = vec4(2.0*x - 1.0, 0.0, 0.0, 1.0);\n      gl_PointSize = 1.0;\n      vColor = Jab;\n    }\n  `,"\n    precision highp float;\n    in vec3 vColor;\n    out vec4 fColor;\n\n    void main() {\n      fColor = vec4(vColor, 1.0);\n    }\n  "),n.reseed=x(g,"\n    layout(location=0) in vec2 aPosition;\n    out vec2 vPosition;\n\n    void main() {\n      vPosition = 0.5 + 0.5*aPosition;\n      gl_Position = vec4(aPosition, 0.0, 1.0);\n    }\n  ","\n    precision highp float;\n    uniform sampler2D uSampler0;\n    uniform sampler2D uSampler1;\n    uniform float uTime;\n    in vec2 vPosition;\n    out vec4 fColor;\n\n    vec2 hash22(vec2 p) {\n      vec3 p3 = fract(vec3(p.xyx)*vec3(.1031, .1030, .0973));\n      p3 += dot(p3, p3.yzx + 33.33);\n      return fract((p3.xx + p3.yz)*p3.zy);\n    }\n\n    void main() {\n      vec2 h = hash22(1e3*vec2(fract(uTime), vPosition.x));\n      vec4 curr = texture(uSampler1, vPosition);\n      vec4 next = texture(uSampler0, h.xy);\n      fColor = curr.w > 0.0 ? curr : next;\n    }\n  "),n.points=x(g,`\n    uniform float uTime;\n    uniform sampler2D uSampler0;\n    layout(location=1) in int aPosition;\n    out vec3 vColor;\n\n    ${o.linAlg}\n    ${o.kMeans}\n    ${o.UCS}\n\n    vec3 sphere(vec2 uv) {\n      float theta = radians(360.0)*uv.x;\n      float phi = acos(1.0 - 2.0*uv.y);\n      float x = sin(phi)*cos(theta);\n      float y = sin(phi)*sin(theta);\n      float z = cos(phi);\n      return vec3(x, y, z);\n    }\n\n    vec4 hash43(vec3 p) {\n      vec4 p4 = fract(vec4(p.xyzx)*vec4(.1031, .1030, .0973, .1099));\n      p4 += dot(p4, p4.wzxy + 33.33);\n      return fract((p4.xxyz + p4.yzzw)*p4.zywx);\n    }\n\n    void main() {\n      ivec2 ts = textureSize(uSampler0, 0);\n      ivec2 xy = ivec2(aPosition%ts.x, aPosition/ts.x);\n      vec2 uv = (0.5 + vec2(xy))/vec2(ts);\n      vec4 h = hash43(1e3*vec3(fract(uTime), uv));\n      vec3 UCS = texture(uSampler0, uv).xyz;\n      vec3 UCS_p = UCS; // uMeans[closest(UCS)];\n      vec3 sRGB_p = UCS_to_sRGB(UCS_p);\n      float c = 0.0; // step(0.95, h.w);\n      vec4 p = vec4(mix(UCS.yxz, UCS_p.yxz, c), 1.0);\n      // p.xyz += 1.0/(1e3*h.z + h.w)*sphere(h.xy);\n      // p.xyz += 3e-3*h.z*sphere(h.xy);\n      p.y -= 0.5;\n      p.xz *= rot(radians(30.0)*uTime);\n      p.z -= 2.0;\n      p = perspective(radians(35.0), 1.0, 1e-3, 1e1)*p;\n      float s = 1.5/p.w;\n      float cs = ceil(s);\n      vColor = mix(1.0, 20.0, c)*(s*s)/(cs*cs)*sRGB_p;\n      gl_Position = p;\n      gl_PointSize = cs;\n    }\n  `,"\n    precision highp float;\n    in vec3 vColor;\n    out vec4 fColor;\n\n    void main() {\n      fColor = vec4(vColor, 1.0);\n    }\n  "),n.downsample=x(g,"\n    layout(location=0) in vec2 aPosition;\n    out vec2 vPosition;\n\n    void main() {\n      vPosition = 0.5 + 0.5*aPosition;\n      gl_Position = vec4(aPosition, 0.0, 1.0);\n    }\n  ","\n    precision highp float;\n    uniform sampler2D uSampler0;\n    in vec2 vPosition;\n    out vec4 fColor;\n\n    void main() {\n      vec2 np = vec2(-1.0, 1.0);\n      vec2 px = 1.0/vec2(textureSize(uSampler0, 0));\n      vec3 rgb =\n        texture(uSampler0, vPosition + np.xx*px).rgb +\n        texture(uSampler0, vPosition + np.xy*px).rgb +\n        texture(uSampler0, vPosition + np.yx*px).rgb +\n        texture(uSampler0, vPosition + np.yy*px).rgb;\n      fColor = vec4(rgb/4.0, 1.0);\n    }\n  "),n.blur=x(g,"\n    layout(location=0) in vec2 aPosition;\n    out vec2 vPosition;\n\n    void main() {\n      vPosition = 0.5 + 0.5*aPosition;\n      gl_Position = vec4(aPosition, 0.0, 1.0);\n    }\n  ","\n    precision highp float;\n    uniform sampler2D uSampler0;\n    uniform sampler2D uSampler1;\n    uniform vec2 uDirection;\n    in vec2 vPosition;\n    out vec4 fColor;\n\n    void main() {\n      vec2 px = uDirection/vec2(textureSize(uSampler0, 0));\n      vec3 acc = texture(uSampler1, vPosition).rgb;\n      for (float x = -5.0; x <= 5.0; x += 1.0) {\n        float sigma = 1.5;\n        float k = 2.0*sigma*sigma;\n        float g = exp(-x*x/k)/sqrt(radians(180.0)*k);\n        acc += g*texture(uSampler0, vPosition + px*x).rgb;\n      }\n      fColor = vec4(acc, 1.0);\n    }\n  "),n.final=x(g,"\n    layout(location=0) in vec2 aPosition;\n    out vec2 vPosition;\n\n    void main() {\n      vPosition = 0.5 + 0.5*aPosition;\n      gl_Position = vec4(aPosition, 0.0, 1.0);\n    }\n  ",`\n    precision highp float;\n    uniform sampler2D uSampler0;\n    uniform sampler2D uSampler1;\n    uniform sampler2D uSampler2;\n    uniform sampler2D uSampler3;\n    in vec2 vPosition;\n    out vec4 fColor;\n\n    ${o.UCS}\n    ${o.ACES}\n\n    void main() {\n      // const vec3 ones = vec3(-1.0, 0.0, 1.0);\n      // const vec2 sp = vec2(5.0, 5.0);\n      vec2 s0 = vec2(textureSize(uSampler0, 0));\n      vec2 s2 = vec2(textureSize(uSampler2, 0));\n      // vec2 uv = (s0*(ones.zy + ones.xz*vPosition) - 24.0)/12.0/sp;\n      // if (0.0 <= min(uv.x, uv.y) && max(uv.x, uv.y) <= 1.0) {\n      //   vec4 UCS = texture(uSampler3, vec2((floor(sp.y*uv.y) + uv.x)/sp.y, 0.5));\n      //   vec3 sRGB = UCS_to_sRGB(UCS.xyz/UCS.w);\n      //   fColor = vec4(sRGB_OETF(sRGB), 1.0);\n      // }\n      // else {\n        vec4 n = texture(uSampler2, s0/s2*vPosition);\n        vec3 c0 = texture(uSampler0, vPosition).rgb;\n        vec3 c1 = texture(uSampler1, vPosition).rgb;\n        fColor = vec4(sRGB_OETF(ACES(c0 + c1/25.0)) + n.rgb/256.0, 1.0);\n      // }\n    }\n  `),n.video=x(g,"\n    layout(location=0) in vec2 aPosition;\n    out vec2 vPosition;\n\n    void main() {\n      vPosition = 0.5 + 0.5*aPosition;\n      gl_Position = vec4(aPosition, 0.0, 1.0);\n    }\n  ",`\n    precision highp float;\n    uniform sampler2D uSampler0;\n    uniform sampler2D uSampler1;\n    uniform sampler2D uSampler2;\n    uniform float uTime;\n    in vec2 vPosition;\n    out vec4 fColor;\n\n    ${o.kMeans}\n    ${o.UCS}\n\n    void main() {\n      const vec3 ones = vec3(-1.0, 0.0, 1.0);\n      const vec2 sp = vec2(8.0, 8.0);\n      vec2 s0 = vec2(textureSize(uSampler0, 0));\n      vec2 s2 = vec2(textureSize(uSampler2, 0));\n      vec2 uv = (s0*(ones.zy + ones.xz*vPosition) - 12.0)/6.0/sp;\n      if (0.0 <= min(uv.x, uv.y) && max(uv.x, uv.y) <= 1.0) {\n        vec4 UCS = texture(uSampler1, vec2((floor(sp.y*uv.y) + uv.x)/sp.y, 0.5));\n        vec3 sRGB = UCS_to_sRGB(UCS.xyz/UCS.w);\n        fColor = vec4(sRGB_OETF(sRGB), 1.0);\n      }\n      else {\n        vec4 noise = texture(uSampler2, s0/s2*vPosition);\n        vec3 dither = 0.06666666666666667*(noise.xyz - 0.5);\n        vec3 UCS = texture(uSampler0, vPosition).xyz + dither;\n        vec3 sRGB = UCS_to_sRGB(uMeans[closest(UCS)]);\n        fColor = vec4(sRGB_OETF(sRGB), 1.0);\n      }\n    }\n  `)})(e||(e={})),function(n){f("preparing textures"),n.size=(n,o)=>e=>{e.texImage2D(3553,0,34836,n,o,0,6408,5126,null)},n.filter=n=>o=>{o.texParameteri(3553,10240,n),o.texParameteri(3553,10241,n)},n.clamp=n=>{n.texParameteri(3553,10242,33071),n.texParameteri(3553,10243,33071)},n.nearest=n.filter(9728),n.linear=n.filter(9729),n.flip=n=>n.pixelStorei(37440,!0),n.source=v(g)(n.linear,n.flip),n.converted=v(g)(n.nearest),n.bluenoise=v(g)(n.nearest),n.points=v(g)(n.linear,n.size(512,512)),n.bloom0=v(g)(n.nearest,n.size(256,256),n.clamp),n.bloom1=v(g)(n.nearest,n.size(256,256),n.clamp),n.bloom2=v(g)(n.linear,n.size(256,256),n.clamp),n.palette0=v(g)(n.nearest,n.size(25,1)),n.palette1=v(g)(n.nearest,n.size(25,1)),n.tmp=v(g)(n.linear,n.clamp),n.bloom=Array.from([,,,,,,,,,].keys(),(()=>v(g)(n.linear,n.clamp))),i(new Image,{src:"bluenoise.png",onload(){g.bindTexture(3553,n.bluenoise),g.texImage2D(3553,0,6408,6408,5121,this)}})}(t||(t={})),r(g)((n=>{const o=new Int32Array(Array(2073600).keys());n.bufferData(34962,o,35044),n.vertexAttribIPointer(1,1,5124,0,0),n.enableVertexAttribArray(1)})),r(g)((n=>{const o=Float32Array.of(-1,-1,1,-1,-1,1,1,1);n.bufferData(34962,o,35044),n.vertexAttribPointer(0,2,5126,!1,0,0),n.enableVertexAttribArray(0)})),g.enable(3042),g.enable(2884),g.blendFunc(1,1),i(g.canvas,{width:512,height:512});(async()=>{const o=new Float32Array(75),i=((n,o=36160)=>{const e=n.createFramebuffer();return s(n,e,(e=>n.bindFramebuffer(o,e)))})(g),a=n=>i((o=>{o.framebufferTexture2D(36160,36064,3553,n,0)}));for(f("entering the render loop");;){f("rendering a frame");const i=await new Promise(requestAnimationFrame),{videoWidth:c,videoHeight:s}=n.video;if(!c){f("the video is empty, skipping");continue}const r=Math.sqrt(1e6/c/s),v=Math.round(r*c),l=Math.round(r*s);n.video.paused||(g.bindTexture(3553,t.source),g.texImage2D(3553,0,6407,6407,5121,n.video)),g.bindTexture(3553,t.converted),g.texImage2D(3553,0,34836,v,l,0,6408,5126,null),f("resize and convert to UCS"),y(d(a(t.converted)),S(e.convert),P(0,0,v,l),C(t.source))(g,(()=>{g.clear(16384),g.drawArrays(5,0,4)})),f("render points"),y(S(e.points),P(0,0,512,512),C(t.converted),d(a(t.points)))(g,(()=>{const n=h(g,e.points);g.uniform1f(n.uTime,.001*i),g.uniform3fv(n.uMeans,o),g.clear(16384),g.drawArrays(0,0,v*l)})),f("bloom: downscale");for(let n=0;t.bloom.length>n;n++){const o=t.bloom[n-1]||t.points,i=t.bloom[n],c=2**-n,s=512*c,r=512*c;g.bindTexture(3553,i),g.texImage2D(3553,0,34836,s,r,0,6408,5126,null),g.bindTexture(3553,null),f(`${s}x${r}`),y(d(a(i)),S(e.downsample),P(0,0,s,r),C(o))(g,(()=>{g.clear(16384),g.drawArrays(5,0,4)}))}f("bloom: upscale");for(let n=t.bloom.length;n--;){const{tmp:o}=t,i=t.bloom[n+1],c=t.bloom[n],s=2**-n,r=512*s,v=512*s,l=h(g,e.blur);g.bindTexture(3553,o),g.texImage2D(3553,0,34836,r,v,0,6408,5126,null),g.bindTexture(3553,null),f(`${r}x${v}`),y(S(e.blur),P(0,0,r,v))(g,(()=>{y(d(a(o)),C(c))(g,(()=>{g.uniform2f(l.uDirection,1,0),g.clear(16384),g.drawArrays(5,0,4)})),y(d(a(c)),C(o,i))(g,(()=>{g.uniform2f(l.uDirection,0,1),g.clear(16384),g.drawArrays(5,0,4)}))}))}f("final pass"),y(S(e.final),P(0,0,512,512),C(t.points,t.bloom[0],t.bluenoise,t.palette1))(g,(()=>{g.clear(16384),g.drawArrays(5,0,4)}))}})();
</script>

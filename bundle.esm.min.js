const n=Object.assign,o=o=>(...t)=>n(document.createElement(o),...t),t=o("canvas"),e=(n,o,t)=>(...e)=>(t(o),e.forEach((t=>t(n,o))),t(null),o),c=(n,o,t)=>n.getUniformLocation(o,t),a=(n,o=34962)=>{const t=n.createBuffer();return e(n,t,(t=>n.bindBuffer(o,t)))},s=(n,o=3553)=>{const t=n.createTexture();return e(n,t,(t=>n.bindTexture(o,t)))},r=(n,o,t)=>{const e="#version 300 es\n"+t,c=n.createShader(o);if(n.shaderSource(c,e),n.compileShader(c),!n.getShaderParameter(c,35713)){const o=n.getShaderInfoLog(c);throw Error(`Shader error:\n${o}\n${((n,o=1)=>n.replace(/^/gm,(()=>(o+++": ").padStart(5,"0"))))(e)}\n`)}return c},_=(n,o,t)=>{const e=n.createProgram();if(n.attachShader(e,r(n,35633,o)),n.attachShader(e,r(n,35632,t)),n.linkProgram(e),!n.getProgramParameter(e,35714)){const o=n.getProgramInfoLog(e);throw Error("Program error: "+o)}return e},i=o("video")({src:"Cyberpunk 2077.mp4",controls:!0,autoplay:!0,loop:!0});window.addEventListener("dragover",(n=>{n.preventDefault()})),window.addEventListener("drop",(n=>{n.preventDefault();const[o]=n.dataTransfer.files;if(o){const n=URL.createObjectURL(o);i.src=n}}));const v=((n,...o)=>{const e=t().getContext("webgl2",n);if(!e)throw Error("WebGL2 is unavailable");for(const n of o)if(!e.getExtension(n))throw Error(`"${n}" extension is unavailable`);return e})({},"EXT_color_buffer_float","EXT_float_blend");document.body.append(i,v.canvas);const l="\n#define diag3(v) mat3((v).x, 0.0, 0.0, 0.0, (v).y, 0.0, 0.0, 0.0, (v).z)\n#define xy_to_XYZ(x, y) vec3(x/y, 1.0, (1.0 - x - y)/y)\n\nconst vec3 D65 = xy_to_XYZ(0.31271, 0.32902);\nconst mat3 sRGB = mat3(xy_to_XYZ(0.64, 0.33), xy_to_XYZ(0.30, 0.60), xy_to_XYZ(0.15, 0.06));\nconst mat3 sRGB_TO_XYZ_D65 = sRGB*diag3(inverse(sRGB)*D65);\nconst mat3 XYZ_D65_TO_sRGB = inverse(sRGB_TO_XYZ_D65);\n\nvec3 sRGB_OETF(vec3 c) {\n  vec3 a = 12.92*c;\n  vec3 b = 1.055*pow(c, vec3(1.0/2.4)) - 0.055;\n  return mix(a, b, greaterThan(c, vec3(0.00313066844250063)));\n}\n\nvec3 sRGB_EOTF(vec3 c) {\n  vec3 a = c/12.92;\n  vec3 b = pow((c + 0.055)/1.055, vec3(2.4));\n  return mix(a, b, greaterThan(c, vec3(0.0404482362771082)));\n}\n\n#define adapt_aux(x) pow(F_L*abs(x), vec3(0.42))\n#define adapt(x) 400.0*sign(x)*adapt_aux(x)/(27.13 + adapt_aux(x))\n#define unadapt(x) sign(x)/F_L*pow(27.13*abs(x)/(400.0 - abs(x)), vec3(1.0/0.42))\n\nconst mat3 M16 = mat3(\n  +0.401288, -0.250268, -0.002079,\n  +0.650173, +1.204414, +0.048952,\n  -0.051461, +0.045854, +0.953127\n);\n\n// sRGB conditions, average surround\nconst vec3 XYZ_w = D65;\nconst float Y_w = XYZ_w.y;\nconst float Y_b = 0.2;\nconst float L_w = 64.0/radians(180.0);\nconst float L_A = L_w*Y_b/Y_w;\nconst float F = 1.0;\nconst float c = 0.69;\nconst float N_c = F;\n\nconst vec3 RGB_w = M16*XYZ_w;\nconst float D = 1.0; // clamp(F*(1.0 - 1.0/3.6*exp((-L_A - 42.0)/92.0)), 0.0, 1.0);\nconst vec3 D_RGB = D*(Y_w/RGB_w) + 1.0 - D;\nconst float k4 = pow(1.0/(5.0*L_A + 1.0), 4.0);\nconst float F_L = k4*L_A + 0.1*pow(1.0 - k4, 2.0)*pow(5.0*L_A, 1.0/3.0);\nconst float n = Y_b/Y_w;\nconst float z = 1.48 + sqrt(n);\nconst float N_bb = 0.725/pow(n, 0.2);\nconst float N_cb = N_bb;\nconst vec3 RGB_cw = D_RGB*RGB_w;\nconst vec3 RGB_aw = adapt(RGB_cw);\nconst float A_w = dot(vec3(2.0, 1.0, 0.05), RGB_aw)*N_bb;\n\nvec3 XYZ_D65_to_CAM16(vec3 XYZ) {\n  vec3 RGB = M16*XYZ;\n  vec3 RGB_c = D_RGB*RGB;\n  vec3 RGB_a = adapt(RGB_c);\n  const mat3x4 m = 1.0/1980.0*mat3x4(\n    3960.0, 1980.0, 220.0, 1980.0,\n    1980.0, -2160.0, 220.0, 1980.0,\n    99.0, 180.0, -440.0, 2079.0\n  );\n  vec4 aux = m*RGB_a;\n  float h = atan(aux.z, aux.y);\n  float e_t = 0.25*(cos(h + 2.0) + 3.8);\n  float A = aux.x*N_bb;\n  float J = pow(A/A_w, c*z);\n  float t = 5e4/13.0*N_c*N_cb*e_t*length(aux.yz)/(aux.w + 0.305);\n  float alpha = pow(t, 0.9)*pow(1.64 - pow(0.29, n), 0.73);\n  float C = 0.01*alpha*sqrt(J);\n  float M = C*pow(F_L, 0.25);\n  return vec3(J, M, h);\n}\n\nvec3 CAM16_to_XYZ_D65(vec3 JMh) {\n  float C = JMh.y/pow(F_L, 0.25);\n  float alpha = 100.0*C/sqrt(JMh.x);\n  float t = pow(alpha/pow(1.64 - pow(0.29, n), 0.73), 1.0/0.9);\n  float e_t = 0.25*(cos(JMh.z + 2.0) + 3.8);\n  float A = A_w*pow(JMh.x, 1.0/(c*z));\n  float p_1 = 5e4/13.0*N_c*N_cb*e_t;\n  float p_2 = A/N_bb;\n  vec2 cs = vec2(cos(JMh.z), sin(JMh.z));\n  float r = 23.0*(p_2 + 0.305)*t/(23.0*p_1 + t*dot(vec2(11.0, 108.0), cs));\n  vec2 ab = r*cs;\n  const mat3 m = 1.0/1403.0*mat3(\n    460.0, 460.0, 460.0,\n    451.0, -891.0, -220.0,\n    288.0, -261.0, -6300.0\n  );\n  vec3 RGB_a = m*vec3(p_2, ab);\n  vec3 RGB_c = unadapt(RGB_a);\n  vec3 RGB = RGB_c/D_RGB;\n  return inverse(M16)*RGB;\n}\n\nvec3 XYZ_D65_to_CAM16_UCS(vec3 XYZ) {\n  vec3 JMh = XYZ_D65_to_CAM16(XYZ);\n  float J = (1.0 + 0.7)*JMh.x/(1.0 + 0.7*JMh.x);\n  float M = 1.0/2.28*log(1.0 + 2.28*JMh.y);\n  return vec3(J, M, JMh.z);\n}\n\nvec3 CAM16_UCS_to_XYZ_D65(vec3 JMh) {\n  float J = JMh.x/(1.0 - (JMh.x - 1.0)*0.7);\n  float M = (exp(JMh.y*2.28) - 1.0)/2.28;\n  return CAM16_to_XYZ_D65(vec3(J, M, JMh.z));\n}\n",f=(_(v,"\n  layout(location=0) in vec2 aPosition;\n  out vec2 vPosition;\n\n  void main() {\n    vPosition = 0.5 + 0.5*aPosition;\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n  }\n",`\n  precision highp float;\n  uniform sampler2D uSrc;\n  in vec2 vPosition;\n  out vec4 fColor;\n\n  ${l}\n\n  vec3 colormap(vec3 rgb) {\n    vec3 JMh = XYZ_D65_to_CAM16_UCS(sRGB_TO_XYZ_D65*rgb);\n    JMh.x = clamp(JMh.x, 0.0, 1.0); // keep lightness\n    JMh.y = 0.84*JMh.x*(1.0 - JMh.x); // almost clipping colorfulness\n    JMh.z = (1.0/6.0 - JMh.x)*radians(360.0); // cute hue\n    return XYZ_D65_TO_sRGB*CAM16_UCS_to_XYZ_D65(JMh);\n  }\n\n  void main() {\n    vec2 s = vec2(textureSize(uSrc, 0))/4.0;\n    vec3 src = sRGB_EOTF(texture(uSrc, floor(s*vPosition)/s).rgb);\n    fColor = vec4(sRGB_OETF(colormap(src)), 1.0);\n  }\n`),_(v,`\n  uniform sampler2D uSrc;\n  uniform float uTime;\n  layout(location=1) in vec2 aPosition;\n  out vec3 vColor;\n\n  ${l}\n\n  mat2 rot(float a) {\n    float c = cos(a);\n    float s = sin(a);\n    return mat2(c, -s, s, c);\n  }\n\n  void main() {\n    // vec2 size = vec2(textureSize(uSrc, 0));\n    // vec2 st = vec2(fract(aPosition/size.x), trunc(aPosition/size.x)/size.y);\n    vec3 sRGB = sRGB_EOTF(texture(uSrc, aPosition).rgb);\n    vec3 JMh = XYZ_D65_to_CAM16_UCS(sRGB_TO_XYZ_D65*sRGB);\n    vec3 Jab = vec3(JMh.x, JMh.y*vec2(cos(JMh.z), sin(JMh.z)));\n    vColor = sRGB;\n    vec3 pos = Jab;\n    pos.x -= 0.5;\n    pos.yz *= rot(radians(30.0)*uTime);\n    pos.xy *= rot(radians(90.0));\n    gl_Position = vec4(pos, 0.6/(1.0 + pos.z));\n    gl_PointSize = 1.0;\n  }\n`,"\n  precision highp float;\n  in vec3 vColor;\n  out vec4 fColor;\n\n  void main() {\n    fColor = vec4(vColor, 1.0);\n  }\n")),u=_(v,"\n  layout(location=0) in vec2 aPosition;\n  out vec2 vPosition;\n\n  void main() {\n    vPosition = 0.5 + 0.5*aPosition;\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n  }\n",`\n  precision highp float;\n  uniform sampler2D sSrc;\n  in vec2 vPosition;\n  out vec4 fColor;\n\n  ${l}\n\n  void main() {\n    vec4 t = texture(sSrc, vPosition);\n    fColor = vec4(sRGB_OETF(0.1*t.rgb), 1.0);\n  }\n`),p=s(v)((n=>{n.texParameteri(3553,10241,9729),n.texParameteri(3553,10240,9729)}),(n=>{n.pixelStorei(37440,!0)})),h=s(v)((n=>{n.texParameteri(3553,10241,9728),n.texParameteri(3553,10240,9728)})),x=((n,o=36160)=>{const t=n.createFramebuffer();return e(n,t,(t=>n.bindFramebuffer(o,t)))})(v)();a(v)((n=>{const o=Float32Array.of(-1,1,-1,-3,3,1);n.bufferData(34962,o,35044),n.vertexAttribPointer(0,2,5126,!1,0,0),n.enableVertexAttribArray(0)})),v.enable(3042),v.blendFunc(1,1),v.clearColor(0,0,0,1);(async()=>{await new Promise((n=>i.addEventListener("canplay",n)));n(v.canvas,{width:560,height:560}),v.viewport(0,0,560,560);let o=new Float32Array(1);for(;;){const n=await new Promise(requestAnimationFrame),{videoWidth:t,videoHeight:e}=i;t&&(o.length!==2*t*e&&a(v)((n=>{o=new Float32Array(2*t*e);let c=0;for(let n=.5;e>n;n++)for(let a=.5;t>a;a++)o[c++]=a/t,o[c++]=n/e;n.bufferData(34962,o,35044),n.vertexAttribPointer(1,2,5126,!1,0,0),n.enableVertexAttribArray(1)})),v.activeTexture(33984),v.bindTexture(3553,p),v.texImage2D(3553,0,6408,6408,5121,i),v.activeTexture(33985),v.bindTexture(3553,h),v.texImage2D(3553,0,34836,560,560,0,6408,5126,null),v.useProgram(f),v.uniform1f(c(v,f,"uTime"),.001*n),v.bindFramebuffer(36160,x),v.framebufferTexture2D(36160,36064,3553,h,0),v.clear(16384),v.drawArrays(0,0,t*e),v.bindFramebuffer(36160,null),v.activeTexture(33984),v.bindTexture(3553,h),v.useProgram(u),v.clear(16384),v.drawArrays(4,0,3))}})();
